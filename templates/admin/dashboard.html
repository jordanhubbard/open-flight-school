{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Admin Dashboard</h1>
    
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="aircraft-tab" data-bs-toggle="tab" data-bs-target="#aircraft" type="button" role="tab">
                Aircraft
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="instructors-tab" data-bs-toggle="tab" data-bs-target="#instructors" type="button" role="tab">
                Instructors
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">
                Bookings
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="adminTabsContent">
        <!-- Aircraft Tab -->
        <div class="tab-pane fade show active" id="aircraft" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Aircraft Management</h2>
                <button class="btn btn-primary" onclick="showAddAircraftModal()">Add Aircraft</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Make/Model</th>
                            <th>Tail Number</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="aircraftTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Instructors Tab -->
        <div class="tab-pane fade" id="instructors" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Instructor Management</h2>
                <button class="btn btn-primary" onclick="showAddInstructorModal()">Add Instructor</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Ratings</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="instructorsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <h2>User Management</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div class="tab-pane fade" id="bookings" role="tabpanel">
            <h2>Booking Management</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Aircraft</th>
                            <th>Instructor</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Aircraft Modal -->
<div class="modal fade" id="aircraftModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aircraftModalTitle">Add Aircraft</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="aircraftForm">
                    <input type="hidden" id="aircraftId">
                    <div class="mb-3">
                        <label for="makeModel" class="form-label">Make/Model</label>
                        <input type="text" class="form-control" id="makeModel" required>
                    </div>
                    <div class="mb-3">
                        <label for="tailNumber" class="form-label">Tail Number</label>
                        <input type="text" class="form-control" id="tailNumber" required>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <input type="text" class="form-control" id="type" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAircraft()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Instructor Modal -->
<div class="modal fade" id="instructorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instructorModalTitle">Add Instructor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="instructorForm">
                    <input type="hidden" id="instructorId">
                    <div class="mb-3">
                        <label for="instructorName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="instructorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="instructorEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="instructorEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="instructorPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="instructorPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="ratings" class="form-label">Ratings</label>
                        <input type="text" class="form-control" id="ratings" placeholder="Comma-separated list">
                    </div>
                    <div class="mb-3">
                        <label for="instructorStatus" class="form-label">Status</label>
                        <select class="form-select" id="instructorStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveInstructor()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="userPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="userPhone">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="newPassword">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isAdmin">
                        <label class="form-check-label" for="isAdmin">Admin Access</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="bookingId">
                    <div class="mb-3">
                        <label for="bookingDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="bookingDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="startTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="startTime" required>
                    </div>
                    <div class="mb-3">
                        <label for="endTime" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="endTime" required>
                    </div>
                    <div class="mb-3">
                        <label for="aircraftSelect" class="form-label">Aircraft</label>
                        <select class="form-select" id="aircraftSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="instructorSelect" class="form-label">Instructor</label>
                        <select class="form-select" id="instructorSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label for="bookingStatus" class="form-label">Status</label>
                        <select class="form-select" id="bookingStatus">
                            <option value="scheduled">Scheduled</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveBooking()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load data when the page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAircraft();
    loadInstructors();
    loadUsers();
    loadBookings();
});

// Aircraft Management
async function loadAircraft() {
    try {
        const response = await fetch('/api/admin/aircraft');
        const aircraft = await response.json();
        const tbody = document.getElementById('aircraftTableBody');
        tbody.innerHTML = '';
        
        aircraft.forEach(a => {
            tbody.innerHTML += `
                <tr>
                    <td>${a.make_model}</td>
                    <td>${a.tail_number}</td>
                    <td>${a.type}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editAircraft(${a.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAircraft(${a.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Error loading aircraft:', error);
        showError('Failed to load aircraft data');
    }
}

function showAddAircraftModal() {
    document.getElementById('aircraftModalTitle').textContent = 'Add Aircraft';
    document.getElementById('aircraftForm').reset();
    document.getElementById('aircraftId').value = '';
    new bootstrap.Modal(document.getElementById('aircraftModal')).show();
}

async function editAircraft(id) {
    try {
        const response = await fetch(`/api/admin/aircraft/${id}`);
        const aircraft = await response.json();
        
        document.getElementById('aircraftModalTitle').textContent = 'Edit Aircraft';
        document.getElementById('aircraftId').value = aircraft.id;
        document.getElementById('makeModel').value = aircraft.make_model;
        document.getElementById('tailNumber').value = aircraft.tail_number;
        document.getElementById('type').value = aircraft.type;
        document.getElementById('status').value = aircraft.status;
        
        new bootstrap.Modal(document.getElementById('aircraftModal')).show();
    } catch (error) {
        console.error('Error loading aircraft:', error);
        showError('Failed to load aircraft data');
    }
}

async function saveAircraft() {
    const id = document.getElementById('aircraftId').value;
    const data = {
        make_model: document.getElementById('makeModel').value,
        tail_number: document.getElementById('tailNumber').value,
        type: document.getElementById('type').value,
        status: document.getElementById('status').value
    };
    
    try {
        const response = await fetch(`/api/admin/aircraft${id ? `/${id}` : ''}`, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('aircraftModal')).hide();
            loadAircraft();
            showSuccess('Aircraft saved successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to save aircraft');
        }
    } catch (error) {
        console.error('Error saving aircraft:', error);
        showError('Failed to save aircraft');
    }
}

async function deleteAircraft(id) {
    if (!confirm('Are you sure you want to delete this aircraft?')) return;
    
    try {
        const response = await fetch(`/api/admin/aircraft/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadAircraft();
            showSuccess('Aircraft deleted successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to delete aircraft');
        }
    } catch (error) {
        console.error('Error deleting aircraft:', error);
        showError('Failed to delete aircraft');
    }
}

// Instructor Management
async function loadInstructors() {
    try {
        const response = await fetch('/api/admin/instructors');
        const instructors = await response.json();
        const tbody = document.getElementById('instructorsTableBody');
        tbody.innerHTML = '';
        
        instructors.forEach(i => {
            tbody.innerHTML += `
                <tr>
                    <td>${i.name}</td>
                    <td>${i.email}</td>
                    <td>${i.phone}</td>
                    <td>${Array.isArray(i.ratings) ? i.ratings.join(', ') : i.ratings}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editInstructor(${i.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInstructor(${i.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Error loading instructors:', error);
        showError('Failed to load instructor data');
    }
}

function showAddInstructorModal() {
    document.getElementById('instructorModalTitle').textContent = 'Add Instructor';
    document.getElementById('instructorForm').reset();
    document.getElementById('instructorId').value = '';
    new bootstrap.Modal(document.getElementById('instructorModal')).show();
}

async function editInstructor(id) {
    try {
        const response = await fetch(`/api/admin/instructors/${id}`);
        const instructor = await response.json();
        
        document.getElementById('instructorModalTitle').textContent = 'Edit Instructor';
        document.getElementById('instructorId').value = instructor.id;
        document.getElementById('instructorName').value = instructor.name;
        document.getElementById('instructorEmail').value = instructor.email;
        document.getElementById('instructorPhone').value = instructor.phone;
        document.getElementById('ratings').value = instructor.ratings.join(', ');
        document.getElementById('instructorStatus').value = instructor.status;
        
        new bootstrap.Modal(document.getElementById('instructorModal')).show();
    } catch (error) {
        console.error('Error loading instructor:', error);
        showError('Failed to load instructor data');
    }
}

async function saveInstructor() {
    const id = document.getElementById('instructorId').value;
    const data = {
        name: document.getElementById('instructorName').value,
        email: document.getElementById('instructorEmail').value,
        phone: document.getElementById('instructorPhone').value,
        ratings: document.getElementById('ratings').value.split(',').map(c => c.trim()),
        status: document.getElementById('instructorStatus').value
    };
    
    try {
        const response = await fetch(`/api/admin/instructors${id ? `/${id}` : ''}`, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('instructorModal')).hide();
            loadInstructors();
            showSuccess('Instructor saved successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to save instructor');
        }
    } catch (error) {
        console.error('Error saving instructor:', error);
        showError('Failed to save instructor');
    }
}

async function deleteInstructor(id) {
    if (!confirm('Are you sure you want to delete this instructor?')) return;
    
    try {
        const response = await fetch(`/api/admin/instructors/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadInstructors();
            showSuccess('Instructor deleted successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to delete instructor');
        }
    } catch (error) {
        console.error('Error deleting instructor:', error);
        showError('Failed to delete instructor');
    }
}

// User Management
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        const users = await response.json();
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        users.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td>${u.first_name} ${u.last_name}</td>
                    <td>${u.email}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.is_admin ? 'Admin' : 'User'}</td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editUser(${u.id})">Edit</button>
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Error loading users:', error);
        showError('Failed to load user data');
    }
}

async function editUser(id) {
    try {
        const response = await fetch(`/api/admin/users/${id}`);
        const user = await response.json();
        
        document.getElementById('userId').value = user.id;
        document.getElementById('firstName').value = user.first_name;
        document.getElementById('lastName').value = user.last_name;
        document.getElementById('userEmail').value = user.email;
        document.getElementById('userPhone').value = user.phone || '';
        document.getElementById('isAdmin').checked = user.is_admin;
        
        new bootstrap.Modal(document.getElementById('userModal')).show();
    } catch (error) {
        console.error('Error loading user:', error);
        showError('Failed to load user data');
    }
}

async function saveUser() {
    const id = document.getElementById('userId').value;
    const data = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        email: document.getElementById('userEmail').value,
        phone: document.getElementById('userPhone').value,
        is_admin: document.getElementById('isAdmin').checked
    };
    
    const newPassword = document.getElementById('newPassword').value;
    if (newPassword) {
        data.password = newPassword;
    }
    
    try {
        const response = await fetch(`/api/admin/users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            loadUsers();
            showSuccess('User updated successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to update user');
        }
    } catch (error) {
        console.error('Error updating user:', error);
        showError('Failed to update user');
    }
}

// Booking Management
async function loadBookings() {
    try {
        const response = await fetch('/api/admin/bookings');
        const bookings = await response.json();
        const tbody = document.getElementById('bookingsTableBody');
        tbody.innerHTML = '';
        
        bookings.forEach(b => {
            const date = new Date(b.start_time);
            const startTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const endTime = new Date(b.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            tbody.innerHTML += `
                <tr>
                    <td>${b.user.name}</td>
                    <td>${date.toLocaleDateString()}</td>
                    <td>${startTime} - ${endTime}</td>
                    <td>${b.aircraft || '-'}</td>
                    <td>${b.instructor || '-'}</td>
                    <td>${b.status}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editBooking(${b.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBooking(${b.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Error loading bookings:', error);
        showError('Failed to load booking data');
    }
}

async function editBooking(id) {
    try {
        const response = await fetch(`/api/admin/bookings/${id}`);
        const booking = await response.json();
        
        const date = new Date(booking.start_time);
        document.getElementById('bookingId').value = booking.id;
        document.getElementById('bookingDate').value = date.toISOString().split('T')[0];
        document.getElementById('startTime').value = date.toLocaleTimeString('en-US', { hour12: false });
        document.getElementById('endTime').value = new Date(booking.end_time).toLocaleTimeString('en-US', { hour12: false });
        document.getElementById('bookingStatus').value = booking.status;
        
        // Load aircraft and instructor options
        await loadAircraftOptions();
        await loadInstructorOptions();
        
        document.getElementById('aircraftSelect').value = booking.aircraft_id || '';
        document.getElementById('instructorSelect').value = booking.instructor_id || '';
        
        new bootstrap.Modal(document.getElementById('bookingModal')).show();
    } catch (error) {
        console.error('Error loading booking:', error);
        showError('Failed to load booking data');
    }
}

async function loadAircraftOptions() {
    try {
        const response = await fetch('/api/admin/aircraft');
        const aircraft = await response.json();
        const select = document.getElementById('aircraftSelect');
        select.innerHTML = '<option value="">Select Aircraft</option>';
        
        aircraft.forEach(a => {
            select.innerHTML += `<option value="${a.id}">${a.make_model} (${a.tail_number})</option>`;
        });
    } catch (error) {
        console.error('Error loading aircraft options:', error);
    }
}

async function loadInstructorOptions() {
    try {
        const response = await fetch('/api/admin/instructors');
        const instructors = await response.json();
        const select = document.getElementById('instructorSelect');
        select.innerHTML = '<option value="">Select Instructor</option>';
        
        instructors.forEach(i => {
            select.innerHTML += `<option value="${i.id}">${i.name}</option>`;
        });
    } catch (error) {
        console.error('Error loading instructor options:', error);
    }
}

async function saveBooking() {
    const id = document.getElementById('bookingId').value;
    const date = document.getElementById('bookingDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    
    const data = {
        start_time: `${date}T${startTime}`,
        end_time: `${date}T${endTime}`,
        aircraft_id: document.getElementById('aircraftSelect').value || null,
        instructor_id: document.getElementById('instructorSelect').value || null,
        status: document.getElementById('bookingStatus').value
    };
    
    try {
        const response = await fetch(`/api/admin/bookings/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
            loadBookings();
            showSuccess('Booking updated successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to update booking');
        }
    } catch (error) {
        console.error('Error updating booking:', error);
        showError('Failed to update booking');
    }
}

async function deleteBooking(id) {
    if (!confirm('Are you sure you want to delete this booking?')) return;
    
    try {
        const response = await fetch(`/api/admin/bookings/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadBookings();
            showSuccess('Booking deleted successfully');
        } else {
            const error = await response.json();
            showError(error.error || 'Failed to delete booking');
        }
    } catch (error) {
        console.error('Error deleting booking:', error);
        showError('Failed to delete booking');
    }
}
</script>
{% endblock %} 